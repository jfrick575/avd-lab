{"apiVersion":"2022-02-14","dependsOn":[],"identity":{"type":"UserAssigned","userAssignedIdentities":{"/subscriptions/02b4788a-7fc7-4485-834f-a7547c61156b/resourceGroups/lab-avd-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/id-avd-prod-we-001":{}}},"location":"West Europe","properties":{"buildTimeoutInMinutes":240,"customize":[{"name":"InstallNotepadPlusPlus","scriptUri":"https://stavdimg9hfe4o.blob.core.windows.net/imagebuilder/install-notepadpp.ps1","type":"PowerShell"},{"restartCheckCommand":"echo 'Restarted successfully'","restartTimeout":"10m","type":"WindowsRestart"},{"inline":["# Wait for any pending operations to complete","Start-Sleep -Seconds 30","# Stop and disable Windows Update service temporarily","Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue","Set-Service -Name wuauserv -StartupType Disabled","# Clear Windows Update cache","Remove-Item -Path 'C:\\Windows\\SoftwareDistribution\\Download\\*' -Recurse -Force -ErrorAction SilentlyContinue","# Clean up temp files and logs","Get-ChildItem -Path C:\\temp -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue","Get-ChildItem -Path C:\\Windows\\Temp -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue","# Clear event logs to reduce image size","wevtutil el | ForEach-Object { wevtutil cl $_ }","# Defragment the disk","Optimize-Volume -DriveLetter C -Defrag -Verbose","# Run disk cleanup","Start-Process -FilePath 'cleanmgr.exe' -ArgumentList '/sagerun:1' -Wait -NoNewWindow -ErrorAction SilentlyContinue"],"name":"PrepareForSysprep","type":"PowerShell"},{"restartCheckCommand":"echo 'Final restart before sysprep'","restartTimeout":"15m","type":"WindowsRestart"},{"inline":["# Final preparations for sysprep","Write-Host 'Starting final sysprep preparations...'","# Ensure Windows Update service is stopped","Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue","# Wait for system to stabilize","Start-Sleep -Seconds 60","# Re-enable Windows Update service for the final image","Set-Service -Name wuauserv -StartupType Manual","Write-Host 'Sysprep preparations complete'"],"name":"FinalSysprepPrep","type":"PowerShell"}],"distribute":[{"artifactTags":{"Environment":"Production","ManagedBy":"Terraform","Owner":"IT-Team","Project":"AVD"},"galleryImageId":"/subscriptions/02b4788a-7fc7-4485-834f-a7547c61156b/resourceGroups/lab-avd-rg/providers/Microsoft.Compute/galleries/sig_avd_lab_we_001/images/win11-multi-session","replicationRegions":["West Europe"],"runOutputName":"win11-avd-image","type":"SharedImage"}],"source":{"offer":"office-365","publisher":"MicrosoftWindowsDesktop","sku":"win11-22h2-avd-m365","type":"PlatformImage","version":"latest"},"vmProfile":{"osDiskSizeGB":128,"vmSize":"Standard_D4s_v3"}},"tags":{"Environment":"Production","ManagedBy":"Terraform","Owner":"IT-Team","Project":"AVD"},"type":"Microsoft.VirtualMachineImages/imageTemplates"}